import os
import openai
from dotenv import load_dotenv
from enums import ToneEnum
import json

load_dotenv()
client = openai.OpenAI(api_key=os.getenv("OPENAI_API_KEY"))

def extract_terms(photo_description: str):  # ✅ 여기서 매개변수로 photo_description 받음
    prompt_extract = f"""
아래 설명에서 등장하는 '인물', '장소', '사물'만 뽑아 JSON 배열로 출력해.
⚠️ 설명에 실제로 쓰인 단어만 넣어. 새로운 단어나 창작한 내용은 절대 넣지 마.
⚠️ 반드시 JSON 배열로만 출력해. 다른 설명은 하지 마.

설명: "{photo_description}"

출력 예시:
["아버지", "바닷가", "모래성"]
"""
    response = client.chat.completions.create(
        model="gpt-4",
        messages=[{"role": "user", "content": prompt_extract}]
    )
    content = response.choices[0].message.content.strip()
    try:
        allowed_terms = json.loads(content)
        if not isinstance(allowed_terms, list):
            allowed_terms = []
    except json.JSONDecodeError:
        allowed_terms = []
    return allowed_terms

def generate_reminder(patient_name: str, photo_description: str, relation: str, tone: ToneEnum):

    allowed_terms = extract_terms(photo_description)
    if not allowed_terms:
        allowed_terms = [relation]

    system_prompt = (
        "너는 치매 환자에게 따뜻한 회상 문장을 건네는 도우미야.\n"
        "너는 지금 보호자의 입장에서 환자에게 직접 말하고 있어.\n"
        "항상 보호자가 환자에게 이야기하는 구조여야 해.\n"
        "절대로 '보호자님', '사용자', '보호자' 같은 단어를 회상 문장에 넣지 마.\n"
        "문장은 환자의 관계에 해당하는 호칭으로 자연스럽게 시작해줘. 예: 할머니, 어머니, 아버지 등\n"
        f"환자의 이름은 '{patient_name}'이지만, 문장에서 직접 사용하지 말고, 대신 보호자와의 관계인 '{relation}'을 호칭으로 사용해줘.\n"
        "예: '숙희님, 숙희야' 이런 표현은 쓰지 마. 관계 호칭만 자연스럽게 써줘.\n"
        f"문체는 '{tone.value}' 스타일로 해줘.\n"
        "문장은 너무 길지 않게, 말 끝은 쉼표(,)나 줄임표(…)로 부드럽게 마무리해줘.\n"
        "도입부는 '오늘은~'처럼 단조롭게 시작하지 말고, 다양한 회상 분위기로 시작해줘.\n"
        "기억을 자극할 수 있는 장소, 분위기, 감정을 꼭 담아줘.\n"
        "생성되는 문장은 마지막에 반드시 '~요', '~다', '~죠' 등으로 자연스럽고 확실하게 끝나도록 해주세요."
        "항상 '오늘은~'으로 시작하지 말고, 상황에 따라 자연스럽고 다양한 문장으로 도입해줘.\n"
        "각 말투 스타일은 아래 기준을 따라야해:\n\n"

        "👉 다정하게:\n"
        "- MBTI로 치면 ENFJ/ISFJ 스타일. 감정에 공감하고 상대방을 배려하는 말투.따뜻한 말과 걱정 섞인 어투.\n "
        "- 상대방을 배려하고 따뜻하게 느껴질 수 있는 말투여야 해.\n"
        "- '~했죠?', '~좋았어요.'처럼 부드럽게 마무리되고 말끝이 올라가는 어미를 써줘.\n"
        "- 감정을 조용히 공감하거나 안심시키는 느낌이 좋고, 친근한 호칭도 적절히 사용해.\n"
        "- 예: '아버지, 오늘은 날씨가 참 좋았죠?… 산책하기 딱 좋았던 기억이 나요.'\n\n"

        "👉 밝게:\n"
        "- MBTI로 치면 ENFP/ESFP 스타일. 활기차고 감정을 풍부하게 표현하는 말투. 느낌표와 긍정적인 말 사용.\n"
        "- 기쁜 감정, 환한 분위기가 느껴지는 말투여야 해.\n"
        "- '~했어요!', '~즐거웠어요!'처럼 느낌표를 적절히 사용해 에너지를 표현해줘.\n"
        "- 긍정적이고 활기찬 단어를 많이 쓰고, 리듬감 있게 말해줘.\n"
        "- 예: '엄마! 오늘 사진 속 그날 기억나죠? 정말 신났었어요!'\n\n"

        "👉 차분하게:\n"
        "- MBTI로 치면 INFJ/ISTJ 스타일. 조용하고 안정적인 말투. 감정은 드러내지 않지만 진정성 있게 전달.\n"
        "- 안정감 있고 잔잔한 분위기가 느껴지는 말투여야 해.\n"
        "- '~였습니다.', '~했답니다.'처럼 서술형 어미를 사용해줘.\n"
        "- 감정을 직접적으로 드러내기보단 조용히 회상하듯 말해줘.\n"
        "- 예: '아버지, 그날도 어김없이 해가 지고 있었습니다… 참 고요한 날이었지요.'\n\n"

        "그리고 문장은 너무 길지 않게, 말 끝은 쉼표(,)나 줄임표(…)를 활용해서 부드럽게 마무리해줘.\n"
        "중간중간 자연스럽게 말을 쉬어주는 느낌을 주면 더 좋아.\n"
        "기억을 자극할 수 있는 장소, 분위기, 감정을 꼭 담아줘."

        "⚠️ 아주 중요한 규칙:\n"
        "- 설명에 등장하지 않는 사람 이름, 장소, 사물, 사건은 절대 추가하지 마.\n"
        "- 설명에 누가 같이 있었다는 정보가 없으면, 같이 있었다고 말하지 마.\n"
        "- '우리가', '함께', '같이', '다 함께'와 같은 표현을 사용하지 마.\n"

    )
    # ✅ prompt를 system_prompt 밖에서 작성
    prompt = f"""
    - 환자 이름: {patient_name}
    - 사진 설명: {photo_description}
    - 환자와 보호자의 관계: {relation}
    - 보호자의 말투 스타일: {tone.value}

    퀴즈 유형은 다음 중 하나를 자동으로 선택해서 생성해주세요:
    1. 이름 맞추기 – 사진 속 사람, 장소, 물건의 이름을 맞추는 문제
    2. 시각 회상 – 사진 배경이나 상황을 설명하고 기억을 유도하는 문제
    3. 자유 회상 – 사진을 보고 떠오를 수 있는 기억을 기반으로 보기 4개를 주고, 가장 관련 있는 것을 고르는 **객관식 퀴즈**로 만들어주세요

    환자가 이해하기 쉽게 다정하고 천천히 말하는 어조로 구성해주세요.
    환자에게 회상 문장을 건네는 상황이라고 생각하고 말투를 구성해주세요.
    문장의 주체는 '보호자', 청자는 '환자'입니다.

    출력 형식:
    회상 문장: ...
    퀴즈 유형: [1, 2, 3 중 하나]
    퀴즈 문제: [한 줄 질문]
    선택지는 반드시 아래 형식을 따르세요:
    선택지:
    1번. [보기1]
    2번. [보기2]
    3번. [보기3]
    4번. [보기4]

    정답: [번호]. [정답 보기 텍스트]

    ❗ 반드시 보기마다 줄을 바꿔서 작성하고, ‘1번, 보기1, 2번, 보기2’처럼 한 줄에 몰아서 쓰지 마세요.
    ❗ 번호는 ‘1번.’ 또는 ‘1번 ’ 형식으로 쓰고, 꼭 보기와 번호를 붙여 주세요.
    ❗ 정답도 같은 형식으로, 보기 텍스트까지 명확하게 써주세요. (예: 정답: 2번. 보기2)
    ❗ 퀴즈 문제는 보호자가 환자에게 묻는 말투여야 합니다.
    예: "그날 우리가 함께 먹었던 음식이 뭐였는지 기억나세요?" 처럼 부드럽고 회상을 유도하는 말투로 질문해 주세요.
    ❗ 제3자가 보호자에게 묻는 형식(예: "오빠와 함께 먹던 음식은 무엇이었을까요?")은 절대 쓰지 마세요.
    ❗ 객관식 보기는 항상 환자의 시점에서 이해되도록 구성해주세요.
    - "나", "너"와 같은 1인칭/2인칭 표현 대신, 사람 이름이나 관계(예: 오빠, 엄마 등)를 사용해주세요.
    - 환자의 이름이 보기로 포함되지 않도록 해주세요.
    - 모든 보기는 환자의 입장에서 **타인을 지칭하는 방식**으로 명확하게 표현해주세요.
    ❗ 아주 중요한 규칙:
    - 사진 설명에 등장하지 않는 사람 이름, 장소, 사물, 사건은 절대 새로 만들어내지 마세요.
    - 사진 설명에 포함된 정보와 관계(`relation`)만 사용하여 회상 문장과 퀴즈를 작성하세요.
    - 다음 단어들만 사용해서 회상 문장과 퀴즈를 만들어. ⚠️ 이 단어들 외에 새로운 인물, 장소, 사물을 절대 넣지 마. 단어 목록: {allowed_terms}

    예시 입력값:
    언제: 봄날
    어디서: 전주 한옥 마을에서 
    어떻게: 내가 한복을
    무엇을: 입고 
    가장 기억에 남는 것: 활짝 웃었다. 이 사진을 엄마가 이쁘다고 했다.
    라는 보기가 있다고 가정을 했을 때 여기서 엄마는 한옥에 갔는지 안 갔는지 모르니까 함부로 갔다고 집어 넣으면 안돼

    예시 (좋은 보기):
    1번. 오빠  
    2번. 엄마  
    3번. 마트 주인  
    4번. 계곡 주인장

    예시 (❌ 피해야 할 보기):
    1번. 나  
    2번. 너  
    3번. 유타  
    4번. 보호자
    """

    response = client.chat.completions.create(
        model="gpt-4",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": prompt}
        ]
    )
    return response.choices[0].message.content

def generate_reminder_simple(photo_description: str, relation: str):
    # 내부에서 기존 함수에 기본값을 넣어 호출
    return generate_reminder(
        patient_name="",
        photo_description=photo_description,
        relation=relation,
        tone=ToneEnum.kind  # tone이 Enum이면 적절한 기본값 넣기
    )

